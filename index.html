<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±±è¥¿çœæ™‹åŒ—ç•…è¡Œäº¤é€šæ–‡åŒ–ç¤¾ - é‡è½½é“è·¯æŠ€æœ¯äº¤æµç¤¾åŒº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --rail-red: #8B0000;
            --coal-gray: #1f1f1f;
            --gold: #DAA520;
        }
       Â 
        body {
            background-color: #0f0f0f;
            background-image: linear-gradient(rgba(139, 0, 0, 0.03) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(139, 0, 0, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
            color: #d4d4d4;
            font-family: 'Noto Sans SC', sans-serif;
        }
       Â 
        /* æƒé™ç³»ç»Ÿ */
        body.president-mode .president-only { display: flex !important; }
        body.president-mode .president-inline { display: inline-flex !important; }
        body.president-mode .president-block { display: block !important; }
        .president-only, .president-inline, .president-block { display: none !important; }
        .author-only { display: none !important; }
        .thread-row[data-is-author="true"] .author-only { display: inline-flex !important; }
       Â 
        /* æŒ‰é’®æ ·å¼ */
        .btn-metal {Â 
            background: linear-gradient(to bottom, #4a4a4a 0%, #2d2d2d 50%, #1f1f1f 100%);Â 
            border: 1px solid #555;Â 
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            transition: all 0.2s;
        }
        .btn-metal:hover { border-color: #777; transform: translateY(-1px); }
       Â 
        .btn-red {Â 
            background: linear-gradient(to bottom, #a52a2a 0%, #8B0000 50%, #6b0000 100%);Â 
            border: 1px solid #a52a2a;Â 
            color: white;
            transition: all 0.2s;
        }
        .btn-red:hover { filter: brightness(1.2); }
       Â 
        .btn-gold {
            background: linear-gradient(to bottom, #DAA520 0%, #B8860B 100%);
            border: 1px solid #DAA520;
            color: #000;
            font-weight: bold;
        }
       Â 
        .btn-shop {
            background: linear-gradient(135deg, #2a2a2a, #1f1f1f);
            border: 1px solid #444;
            color: #DAA520;
            transition: all 0.3s;
        }
        .btn-shop:hover {
            border-color: #DAA520;
            box-shadow: 0 0 15px rgba(218,165,32,0.3);
            transform: translateY(-2px);
        }
       Â 
        /* è®ºå›è¡¨æ ¼ */
        .forum-table { border: 1px solid #333; box-shadow: 0 4px 6px rgba(0,0,0,0.5); }
        .forum-header { background: linear-gradient(to bottom, #2a2a2a, #1a1a1a); border-bottom: 2px solid #8B0000; }
        .forum-row {Â 
            background: linear-gradient(to bottom, #252525, #1e1e1e);Â 
            border-bottom: 1px solid #333;Â 
            transition: all 0.3s ease;
        }
        .forum-row:hover {Â 
            background: linear-gradient(to bottom, #2a2a2a, #222);Â 
        }
        .forum-row.expanded {Â 
            background: linear-gradient(to bottom, #1e1e1e, #1a1a1a);Â 
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.5);
        }
        .sticky-top { background: linear-gradient(to right, rgba(218, 165, 32, 0.1), transparent); border-left: 3px solid #DAA520; }
       Â 
        /* å¸–å­å†…å®¹å±•å¼€åŒºåŸŸ */
        .post-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.3s ease;
            opacity: 0;
        }
        .post-content.expanded {
            max-height: 1000px;
            opacity: 1;
            padding-top: 1rem;
            margin-top: 0.5rem;
            border-top: 1px solid #333;
        }
        .post-content-text {
            color: #ccc;
            line-height: 1.8;
            font-size: 0.95rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
       Â 
        /* å•†åŸå•†å“å¡ç‰‡ */
        .shop-item {
            background: linear-gradient(135deg, #1f1f1f, #2a2a2a);
            border: 1px solid #333;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .shop-item:hover {
            border-color: #DAA520;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 20px rgba(218,165,32,0.1);
        }
        .shop-item::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(218,165,32,0.1), transparent);
            transition: left 0.5s;
        }
        .shop-item:hover::before { left: 100%; }
       Â 
        /* å¤´åƒæ¡†æ•ˆæœ */
        .avatar-frame-gold { border: 3px solid #DAA520; box-shadow: 0 0 15px rgba(218,165,32,0.5); }
        .avatar-frame-silver { border: 3px solid #C0C0C0; box-shadow: 0 0 10px rgba(192,192,192,0.3); }
        .avatar-frame-bronze { border: 3px solid #CD7F32; box-shadow: 0 0 10px rgba(205,127,50,0.3); }
        .avatar-frame-rail { border: 3px solid #8B0000; box-shadow: 0 0 10px rgba(139,0,0,0.4); }
       Â 
        /* ç”¨æˆ·åç‰¹æ•ˆ */
        .name-gold { color: #DAA520; text-shadow: 0 0 10px rgba(218,165,32,0.4); }
        .name-red { color: #ff4444; text-shadow: 0 0 8px rgba(255,68,68,0.3); }
        .name-blue { color: #4169E1; text-shadow: 0 0 8px rgba(65,105,225,0.3); }
       Â 
        /* å‹‹ç«  */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 12px;
            margin-left: 4px;
            cursor: help;
            position: relative;
        }
        .badge:hover::after {
            content: attr(data-title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            border: 1px solid #444;
            z-index: 100;
        }
       Â 
        /* ç§¯åˆ†åŠ¨ç”» */
        @keyframes pointsFloat {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-30px); opacity: 0; }
        }
        .points-float {
            position: fixed;
            color: #DAA520;
            font-weight: bold;
            font-size: 18px;
            pointer-events: none;
            animation: pointsFloat 1s ease-out forwards;
            z-index: 9999;
            text-shadow: 0 0 10px rgba(218,165,32,0.8);
        }
       Â 
        /* èƒŒåŒ…ç‰©å“ */
        .inventory-item {
            background: rgba(0,0,0,0.3);
            border: 1px solid #444;
            transition: all 0.2s;
        }
        .inventory-item:hover { border-color: #DAA520; }
        .inventory-item.equipped {Â 
            border-color: #DAA520;Â 
            background: rgba(218,165,32,0.1);
            box-shadow: 0 0 10px rgba(218,165,32,0.2);
        }
       Â 
        .stat-number { font-family: 'JetBrains Mono', monospace; color: #DAA520; }
        .hidden-trigger { position: fixed; bottom: 0; right: 0; width: 10px; height: 10px; opacity: 0; z-index: 9999; }
       Â 
        ::-webkit-scrollbar { width: 10px; background: #0f0f0f; }
        ::-webkit-scrollbar-thumb { background: #333; border: 1px solid #444; }
       Â 
        .modal-enter { animation: modalSlide 0.3s ease-out; }
        @keyframes modalSlide { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
       Â 
        /* å±•å¼€/æ”¶èµ·æŒ‡ç¤ºå™¨ */
        .expand-indicator {
            transition: transform 0.3s ease;
        }
        .expanded .expand-indicator {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div class="hidden-trigger" id="president-trigger" onclick="handleSecretTrigger()"></div>

    <!-- é¡¶éƒ¨æ  -->
    <div class="bg-[#151515] border-b border-[#333] text-xs py-2 px-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <span class="text-gray-500">åŒ—äº¬æ—¶é—´: <span class="text-[#DAA520] font-mono" id="beijing-time">--:--:--</span></span>
                <span class="text-gray-600">|</span>
                <span class="text-gray-500 text-[10px] opacity-60"><i class="fas fa-shield-alt mr-1"></i>ç³»ç»Ÿå®‰å…¨ç»´æŠ¤ä¸­</span>
            </div>
            <div class="flex items-center gap-4">
                <span>å¸–å­: <span class="stat-number" id="stat-posts">0</span></span>
                <span>ä¼šå‘˜: <span class="stat-number">1,247</span></span>
                <span>åœ¨çº¿: <span class="stat-number text-green-500">56</span></span>
            </div>
        </div>
    </div>

    <!-- å¯¼èˆª -->
    <nav class="sticky top-0 z-50 bg-[#1f1f1f] border-b-2 border-[#8B0000] shadow-lg">
        <div class="max-w-7xl mx-auto flex items-center h-14 px-4">
            <div class="flex items-center gap-2 mr-8 cursor-pointer" onclick="if(DB.currentUser && DB.currentUser.role === 'president') location.reload()">
                <i class="fas fa-train text-[#8B0000] text-xl"></i>
                <span class="font-black text-white text-lg tracking-wider">æ™‹åŒ—ç•…è¡Œ</span>
                <span class="president-only ml-2 px-2 py-0.5 bg-[#DAA520] text-black text-[10px] font-bold rounded hidden">ç®¡ç†</span>
            </div>
           Â 
            <div class="hidden md:flex items-center gap-1">
                <a href="#" class="px-4 py-2 text-gray-300 hover:text-white hover:bg-white/5 rounded transition-colors">é¦–é¡µ</a>
                <a href="#" class="px-4 py-2 text-gray-300 hover:text-white hover:bg-white/5 rounded transition-colors">æŠ€æœ¯åŒº</a>
                <a href="#" class="px-4 py-2 text-gray-300 hover:text-white hover:bg-white/5 rounded transition-colors">æ‘„å½±åŒº</a>
                <button onclick="openShop()" class="px-4 py-2 text-[#DAA520] hover:text-[#FFD700] transition-colors font-medium relative">
                    <i class="fas fa-store mr-1"></i>ç§¯åˆ†å•†åŸ
                    <span class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                </button>
                <button onclick="showRules()" class="px-4 py-2 text-[#8B0000] hover:text-[#ff0000] transition-colors font-medium">
                    <i class="fas fa-gavel mr-1"></i>ç¤¾åŒºæ³•è§„
                </button>
            </div>
           Â 
            <div class="flex-1"></div>
           Â 
            <div id="user-area" class="flex items-center gap-3">
                <div id="guest-state">
                    <button onclick="showAuth()" class="btn-metal px-4 py-1.5 rounded text-sm text-white">ç™»å½• / æ³¨å†Œ</button>
                </div>
                <div id="user-state" class="hidden flex items-center gap-3">
                    <div class="flex items-center gap-2 bg-[#0f0f0f] border border-[#333] px-3 py-1.5 rounded-full cursor-pointer hover:border-[#DAA520] transition-colors" onclick="openShop()">
                        <i class="fas fa-coins text-[#DAA520]"></i>
                        <span id="nav-points" class="text-[#DAA520] font-bold text-sm">0</span>
                    </div>
                    <div class="relative group">
                        <img id="user-avatar" src="" class="w-8 h-8 rounded-full border-2 border-[#444] group-hover:border-[#DAA520] transition-all cursor-pointer object-cover bg-[#333]" onclick="openAvatarModal()" title="ç‚¹å‡»æ›´æ¢å¤´åƒ">
                        <div class="absolute inset-0 bg-black/50 rounded-full opacity-0 group-hover:opacity-100 flex items-center justify-center cursor-pointer transition-opacity" onclick="openAvatarModal()">
                            <i class="fas fa-camera text-white text-xs"></i>
                        </div>
                    </div>
                    <span id="nav-username" class="font-bold text-sm"></span>
                    <button onclick="logout()" class="text-gray-500 hover:text-white text-sm"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¼šé•¿ç®¡ç†æ¡ -->
    <div class="president-only bg-gradient-to-r from-[#1f1f1f] via-[#2a2000] to-[#1f1f1f] border-b border-[#DAA520]/30 px-4 py-2 hidden">
        <div class="max-w-7xl mx-auto flex items-center justify-between text-xs">
            <div class="flex items-center gap-4 text-[#DAA520]">
                <span><i class="fas fa-crown mr-1"></i>æœ€é«˜ç®¡ç†æƒé™å·²æ¿€æ´»</span>
                <span>|</span>
                <span>æ— é™ç§¯åˆ†æ¨¡å¼ | æ‚¨å¯ä»¥ä¿®æ”¹ã€åˆ é™¤å…¨ç«™ä»»ä½•å†…å®¹ï¼Œå‘æ”¾/æ‰£é™¤ç§¯åˆ†</span>
            </div>
            <div class="flex gap-3">
                <button onclick="managePoints()" class="text-[#DAA520] hover:text-[#FFD700]"><i class="fas fa-coins mr-1"></i>ç§¯åˆ†ç®¡ç†</button>
                <button onclick="viewAuditLog()" class="text-gray-400 hover:text-white"><i class="fas fa-clipboard-list mr-1"></i>å®¡æ ¸æ—¥å¿—</button>
            </div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹ -->
    <main class="flex-1 max-w-7xl mx-auto w-full p-4 grid grid-cols-1 lg:grid-cols-4 gap-6 mt-4">
       Â 
        <!-- å·¦ä¾§å†…å®¹åŒº -->
        <div class="lg:col-span-3 space-y-4">
            <!-- ç½®é¡¶åŒº -->
            <div class="forum-table rounded-lg overflow-hidden">
                <div class="forum-header px-4 py-3 bg-[#2a2a2a] flex justify-between items-center">
                    <h2 class="font-bold text-white flex items-center gap-2"><i class="fas fa-thumbtack text-[#DAA520]"></i>å…¬å‘ŠåŒº</h2>
                    <span class="text-xs text-gray-500">ç‰ˆä¸»: ç®¡ç†å‘˜</span>
                </div>
                <div id="sticky-list" class="divide-y divide-[#333]"></div>
            </div>

            <!-- æ“ä½œæ  -->
            <div class="flex flex-wrap items-center justify-between gap-3 bg-[#1a1a1a] p-3 rounded-lg border border-[#333]">
                <div class="flex items-center gap-2">
                    <select id="filter-sort" class="bg-[#0f0f0f] border border-[#444] text-gray-300 text-sm rounded px-3 py-1.5">
                        <option value="new">æœ€æ–°å‘å¸ƒ</option>
                        <option value="hot">çƒ­åº¦æœ€é«˜</option>
                        <option value="essence">ç²¾åå¸–</option>
                    </select>
                </div>
                <button onclick="openPostModal()" class="btn-red px-4 py-1.5 rounded text-sm font-bold flex items-center gap-2">
                    <i class="fas fa-plus"></i>å‘å¸ƒå¸–å­
                </button>
            </div>

            <!-- å¸–å­åˆ—è¡¨ -->
            <div class="forum-table rounded-lg overflow-hidden" id="thread-container">
                <div class="forum-header px-4 py-3">
                    <h2 class="font-bold text-white">è®¨è®ºåŒº</h2>
                </div>
                <div id="thread-list" class="divide-y divide-[#333]"></div>
            </div>
        </div>

        <!-- ä¾§è¾¹æ  -->
        <aside class="space-y-4">
            <!-- å¿«æ·å…¥å£ -->
            <div class="bg-gradient-to-br from-[#1f1f1f] to-[#2a0000] border border-[#8B0000]/30 rounded-lg p-4 shadow-lg">
                <h3 class="font-bold text-white mb-4 flex items-center gap-2">
                    <i class="fas fa-bolt text-[#DAA520]"></i>å¿«æ·é€šé“
                </h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="openShop()" class="btn-shop py-3 rounded flex flex-col items-center gap-1 group">
                        <i class="fas fa-store text-2xl group-hover:scale-110 transition-transform"></i>
                        <span class="text-xs">ç§¯åˆ†å•†åŸ</span>
                    </button>
                    <button onclick="openInventory()" class="btn-shop py-3 rounded flex flex-col items-center gap-1 group">
                        <i class="fas fa-box-open text-2xl group-hover:scale-110 transition-transform"></i>
                        <span class="text-xs">æˆ‘çš„èƒŒåŒ…</span>
                    </button>
                </div>
            </div>

            <!-- ä¸ªäººä¿¡æ¯ -->
            <div id="sidebar-profile" class="hidden bg-[#1a1a1a] border border-[#333] rounded-lg p-4">
                <div class="flex items-center gap-3 mb-4">
                    <div class="relative group cursor-pointer" onclick="openAvatarModal()">
                        <img id="sidebar-avatar" src="" class="w-16 h-16 rounded-full border-2 border-[#444] group-hover:border-[#DAA520] transition-all object-cover bg-[#333]" alt="">
                        <div id="sidebar-frame" class="absolute inset-0 rounded-full pointer-events-none"></div>
                        <div class="absolute inset-0 bg-black/60 rounded-full opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                            <i class="fas fa-camera text-[#DAA520] text-lg"></i>
                        </div>
                    </div>
                    <div class="flex-1">
                        <div id="sidebar-username" class="font-bold text-white flex items-center gap-1"></div>
                        <div id="sidebar-role" class="text-xs text-gray-500 mb-1"></div>
                        <div class="flex items-center gap-2 text-[#DAA520] text-sm font-bold bg-[#0f0f0f] px-2 py-1 rounded w-fit border border-[#333]">
                            <i class="fas fa-coins"></i>
                            <span id="sidebar-points">0</span>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 text-center text-xs">
                    <div class="bg-[#0f0f0f] p-2 rounded border border-[#333]">
                        <div class="text-[#DAA520] font-bold" id="user-post-count">0</div>
                        <div class="text-gray-500">æˆ‘çš„å¸–å­</div>
                    </div>
                    <div class="bg-[#0f0f0f] p-2 rounded border border-[#333] cursor-pointer hover:border-[#DAA520] transition-colors" onclick="openInventory()">
                        <div class="text-[#DAA520] font-bold" id="user-item-count">0</div>
                        <div class="text-gray-500">è£…é¥°å“</div>
                    </div>
                </div>
                <button onclick="openShop()" class="w-full mt-3 btn-gold py-2 rounded text-sm font-bold flex items-center justify-center gap-2">
                    <i class="fas fa-shopping-cart"></i>å»å•†åŸå…‘æ¢
                </button>
            </div>

            <!-- è·å–ç§¯åˆ†æ–¹å¼ -->
            <div class="bg-[#1a1a1a] border border-[#333] rounded-lg p-4">
                <h3 class="font-bold text-white mb-3 text-sm flex items-center gap-2">
                    <i class="fas fa-info-circle text-[#8B0000]"></i>å¦‚ä½•è·å¾—ç§¯åˆ†ï¼Ÿ
                </h3>
                <ul class="space-y-2 text-xs text-gray-400">
                    <li class="flex justify-between items-center bg-[#0f0f0f] p-2 rounded">
                        <span><i class="fas fa-file-alt mr-1 text-gray-500"></i>å‘å¸ƒå¸–å­</span>
                        <span class="text-[#DAA520] font-bold">+10</span>
                    </li>
                    <li class="flex justify-between items-center bg-[#0f0f0f] p-2 rounded">
                        <span><i class="fas fa-check-circle mr-1 text-gray-500"></i>æ¯æ—¥ç­¾åˆ°</span>
                        <span class="text-[#DAA520] font-bold">+5</span>
                    </li>
                    <li class="flex justify-between items-center bg-[#0f0f0f] p-2 rounded">
                        <span><i class="fas fa-gift mr-1 text-gray-500"></i>æ”¶åˆ°æ‰“èµ</span>
                        <span class="text-[#DAA520] font-bold">+1/10ç§¯åˆ†</span>
                    </li>
                    <li class="flex justify-between items-center bg-[#0f0f0f] p-2 rounded">
                        <span><i class="fas fa-gem mr-1 text-gray-500"></i>å¸–å­åŠ ç²¾</span>
                        <span class="text-[#DAA520] font-bold">+50</span>
                    </li>
                </ul>
            </div>
        </aside>
    </main>

    <!-- ================= æ¨¡æ€æ¡† ================= -->

    <!-- æ‰“èµæ¨¡æ€æ¡† -->
    <div id="reward-modal" class="hidden fixed inset-0 z-[1002] bg-black/95 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-[#1f1f1f] border border-[#DAA520] rounded-lg w-full max-w-md modal-enter relative">
            <div class="bg-gradient-to-r from-[#2a2000] to-[#1f1f1f] p-4 border-b border-[#DAA520]/30 flex justify-between items-center">
                <h3 class="font-bold text-[#DAA520] flex items-center gap-2">
                    <i class="fas fa-gift"></i>æ‰“èµå¸–å­
                </h3>
                <button onclick="closeRewardModal()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="text-center">
                    <p class="text-gray-400 text-sm mb-1">å‘ä½œè€… <span id="reward-target-name" class="text-[#DAA520] font-bold"></span> æ‰“èµ</p>
                    <p class="text-xs text-gray-500">æ‰“èµ10ç§¯åˆ†ï¼Œå¯¹æ–¹è·å¾—1ç§¯åˆ†ï¼ˆç±»ä¼¼Bç«™æŠ•å¸æœºåˆ¶ï¼‰</p>
                </div>
               Â 
                <div class="grid grid-cols-4 gap-2 mb-2">
                    <button onclick="selectRewardAmount(10)" class="reward-btn bg-[#0f0f0f] border border-[#444] hover:border-[#DAA520] text-white py-2 rounded text-sm transition-colors" data-amount="10">
                        <div class="text-[#DAA520] font-bold">10</div>
                        <div class="text-[10px] text-gray-500">ç§¯åˆ†</div>
                    </button>
                    <button onclick="selectRewardAmount(20)" class="reward-btn bg-[#0f0f0f] border border-[#444] hover:border-[#DAA520] text-white py-2 rounded text-sm transition-colors" data-amount="20">
                        <div class="text-[#DAA520] font-bold">20</div>
                        <div class="text-[10px] text-gray-500">ç§¯åˆ†</div>
                    </button>
                    <button onclick="selectRewardAmount(50)" class="reward-btn bg-[#0f0f0f] border border-[#444] hover:border-[#DAA520] text-white py-2 rounded text-sm transition-colors" data-amount="50">
                        <div class="text-[#DAA520] font-bold">50</div>
                        <div class="text-[10px] text-gray-500">ç§¯åˆ†</div>
                    </button>
                    <button onclick="selectRewardAmount(100)" class="reward-btn bg-[#0f0f0f] border border-[#444] hover:border-[#DAA520] text-white py-2 rounded text-sm transition-colors" data-amount="100">
                        <div class="text-[#DAA520] font-bold">100</div>
                        <div class="text-[10px] text-gray-500">ç§¯åˆ†</div>
                    </button>
                </div>
               Â 
                <div class="bg-[#0f0f0f] p-3 rounded border border-[#333]">
                    <div class="text-xs text-gray-400 mb-2">è‡ªå®šä¹‰é‡‘é¢ï¼ˆ10çš„å€æ•°ï¼‰</div>
                    <input type="number" id="reward-custom-amount" placeholder="è¾“å…¥ç§¯åˆ†æ•°é‡" min="10" step="10"Â 
                           class="w-full bg-[#1a1a1a] border border-[#444] rounded px-3 py-2 text-white text-sm focus:border-[#DAA520] outline-none">
                </div>
               Â 
                <div class="bg-[#0f0f0f] p-3 rounded border border-[#333] text-xs space-y-1">
                    <div class="flex justify-between text-gray-400">
                        <span>æ‚¨å°†æ”¯ä»˜:</span>
                        <span class="text-white font-bold" id="reward-pay">0 ç§¯åˆ†</span>
                    </div>
                    <div class="flex justify-between text-gray-400">
                        <span>ä½œè€…è·å¾—:</span>
                        <span class="text-[#DAA520] font-bold" id="reward-get">0 ç§¯åˆ†</span>
                    </div>
                    <div class="flex justify-between text-[10px] text-gray-600 pt-1 border-t border-[#333]">
                        <span>å¹³å°æœåŠ¡è´¹(90%):</span>
                        <span id="reward-fee">0 ç§¯åˆ†</span>
                    </div>
                </div>
               Â 
                <button onclick="submitReward()" id="reward-submit-btn" class="w-full btn-gold py-3 rounded text-sm font-bold opacity-50 cursor-not-allowed" disabled>
                    ç¡®è®¤æ‰“èµ
                </button>
            </div>
        </div>
    </div>

    <!-- ç§¯åˆ†å•†åŸæ¨¡æ€æ¡† -->
    <div id="shop-modal" class="hidden fixed inset-0 z-[1001] bg-black/95 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-[#1f1f1f] border border-[#444] rounded-lg w-full max-w-4xl h-[85vh] flex flex-col modal-enter">
            <div class="flex items-center justify-between p-4 border-b border-[#444] bg-gradient-to-r from-[#1f1f1f] to-[#2a2000]">
                <div class="flex items-center gap-3">
                    <i class="fas fa-store text-[#DAA520] text-2xl"></i>
                    <div>
                        <h3 class="font-bold text-white text-lg">ç§¯åˆ†å•†åŸ</h3>
                        <p class="text-xs text-gray-500">ä½¿ç”¨ç§¯åˆ†å…‘æ¢è£…é¥°å“ï¼Œå½°æ˜¾æ‚¨çš„èº«ä»½</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="bg-[#0f0f0f] border border-[#DAA520] px-4 py-2 rounded-full flex items-center gap-2">
                        <i class="fas fa-coins text-[#DAA520]"></i>
                        <span class="text-[#DAA520] font-bold" id="shop-points">0</span>
                        <span class="text-xs text-gray-500">ç§¯åˆ†</span>
                    </div>
                    <button onclick="closeShop()" class="text-gray-500 hover:text-white w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
           Â 
            <div class="flex flex-1 overflow-hidden">
                <!-- å•†å“åˆ—è¡¨ -->
                <div class="flex-1 overflow-y-auto p-6">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="shop-items">
                        <!-- åŠ¨æ€ç”Ÿæˆå•†å“ -->
                    </div>
                </div>
               Â 
                <!-- æˆ‘çš„èƒŒåŒ…ä¾§è¾¹æ  -->
                <div class="w-64 border-l border-[#333] bg-[#1a1a1a] p-4 overflow-y-auto" id="inventory-panel">
                    <h4 class="font-bold text-white mb-3 flex items-center gap-2">
                        <i class="fas fa-box text-[#DAA520]"></i>æˆ‘çš„èƒŒåŒ…
                    </h4>
                    <div id="inventory-list" class="space-y-2">
                        <p class="text-xs text-gray-500 text-center py-4">æš‚æ— è£…é¥°å“</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æˆ‘çš„èƒŒåŒ…æ¨¡æ€æ¡†ï¼ˆç‹¬ç«‹å…¥å£ï¼‰ -->
    <div id="inventory-modal" class="hidden fixed inset-0 z-[1000] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-[#1f1f1f] border border-[#444] rounded-lg w-full max-w-2xl modal-enter">
            <div class="flex items-center justify-between p-4 border-b border-[#444]">
                <h3 class="font-bold text-white flex items-center gap-2"><i class="fas fa-box-open text-[#DAA520]"></i>æˆ‘çš„èƒŒåŒ…</h3>
                <button onclick="closeInventory()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <div id="inventory-detail-list" class="grid grid-cols-3 gap-4">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="mt-6 pt-4 border-t border-[#333]">
                    <h4 class="text-sm font-bold text-white mb-2">å½“å‰è£…æ‰®é¢„è§ˆ</h4>
                    <div class="flex items-center gap-4 bg-[#0f0f0f] p-4 rounded border border-[#333]">
                        <div class="relative">
                            <img id="preview-avatar" src="" class="w-16 h-16 rounded-full object-cover bg-[#333]">
                            <div id="preview-frame" class="absolute inset-0 rounded-full pointer-events-none"></div>
                        </div>
                        <div>
                            <div id="preview-username" class="font-bold"></div>
                            <div id="preview-badges" class="flex gap-1 mt-1"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¤´åƒä¸Šä¼ æ¨¡æ€æ¡† -->
    <div id="avatar-modal" class="hidden fixed inset-0 z-[1000] bg-black/95 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-[#1f1f1f] border border-[#444] rounded-lg w-full max-w-md modal-enter">
            <div class="flex items-center justify-between p-4 border-b border-[#444]">
                <h3 class="font-bold text-white"><i class="fas fa-user-circle text-[#DAA520] mr-2"></i>æ›´æ¢å¤´åƒ</h3>
                <button onclick="closeAvatarModal()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex justify-center mb-4">
                    <img id="avatar-current-preview" src="" class="w-24 h-24 rounded-full border-4 border-[#444] object-cover bg-[#333]">
                </div>
                <div id="avatar-upload-zone" class="border-2 border-dashed border-[#444] rounded-lg p-8 text-center cursor-pointer hover:border-[#8B0000] transition-colors relative">
                    <input type="file" id="avatar-input" accept="image/jpeg,image/png,image/gif" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleAvatarSelect(event)">
                    <i class="fas fa-cloud-upload-alt text-3xl text-[#444] mb-2"></i>
                    <p class="text-gray-400 text-sm">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å¤´åƒ</p>
                    <p class="text-gray-600 text-xs mt-1">æ”¯æŒ JPGã€PNGã€GIFï¼Œæœ€å¤§ 2MB</p>
                </div>
                <div id="avatar-new-preview-container" class="hidden text-center">
                    <img id="avatar-new-preview" src="" class="w-20 h-20 rounded-full border-2 border-[#DAA520] object-cover mx-auto">
                    <p class="text-xs text-gray-400 mt-2">æ–°å¤´åƒé¢„è§ˆ</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeAvatarModal()" class="flex-1 btn-metal py-2 rounded text-sm">å–æ¶ˆ</button>
                    <button onclick="saveAvatar()" id="avatar-save-btn" class="flex-1 btn-red py-2 rounded text-sm font-bold opacity-50" disabled>ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† -->
    <div id="auth-modal" class="hidden fixed inset-0 z-[1000] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-[#1f1f1f] border border-[#444] rounded-lg w-full max-w-md modal-enter relative">
            <div class="flex border-b border-[#444]">
                <button onclick="switchAuth('login')" id="auth-tab-login" class="flex-1 py-3 text-center font-bold bg-[#8B0000] text-white">ç™»å½•</button>
                <button onclick="switchAuth('register')" id="auth-tab-reg" class="flex-1 py-3 text-center font-bold text-gray-400 hover:bg-[#2a2a2a]">æ³¨å†Œ</button>
            </div>
            <div class="p-6 space-y-4">
                <div id="auth-login-panel">
                    <div class="space-y-3">
                        <input type="text" id="login-user" placeholder="ç”¨æˆ·å" class="w-full bg-[#0f0f0f] border border-[#444] rounded px-3 py-2 text-white focus:border-[#8B0000] outline-none">
                        <input type="password" id="login-pass" placeholder="å¯†ç " class="w-full bg-[#0f0f0f] border border-[#444] rounded px-3 py-2 text-white focus:border-[#8B0000] outline-none">
                        <div class="p-3 bg-[#1a1a1a] border border-[#333] rounded">
                            <div class="text-xs text-gray-400 mb-2">å®‰å…¨éªŒè¯ - å¯†ä¿ç­”æ¡ˆ</div>
                            <select id="login-question" class="w-full bg-[#0f0f0f] border border-[#444] rounded px-2 py-1.5 text-sm text-gray-300 mb-2">
                                <option value="1">æ‚¨æ¯äº²çš„å§“åæ˜¯ï¼Ÿ</option>
                                <option value="2">æ‚¨çš„ç¬¬ä¸€è¾†æ¨¡å‹è½¦æ˜¯ï¼Ÿ</option>
                                <option value="3">æ‚¨æœ€å–œçˆ±çš„æœºè½¦å‹å·æ˜¯ï¼Ÿ</option>
                                <option value="president" class="hidden" id="president-question">ç®¡ç†å‘˜ä¸“ç”¨éªŒè¯é€šé“</option>
                            </select>
                            <input type="password" id="login-security" placeholder="å¯†ä¿ç­”æ¡ˆ" class="w-full bg-[#0f0f0f] border border-[#444] rounded px-3 py-2 text-sm text-white">
                        </div>
                        <button onclick="handleLogin()" class="btn-red w-full py-2 rounded font-bold">å®‰å…¨ç™»å½•</button>
                    </div>
                </div>
                <div id="auth-reg-panel" class="hidden space-y-3">
                    <input type="text" id="reg-user" placeholder="ç”¨æˆ·å" class="w-full bg-[#0f0f0f] border border-[#444] rounded px-3 py-2 text-white text-sm">
                    <input type="password" id="reg-pass" placeholder="å¯†ç " class="w-full bg-[#0f0f0f] border border-[#444] rounded px-3 py-2 text-white text-sm">
                    <input type="email" id="reg-email" placeholder="é‚®ç®±" class="w-full bg-[#0f0f0f] border border-[#444] rounded px-3 py-2 text-white text-sm">
                    <select id="reg-question" class="w-full bg-[#0f0f0f] border border-[#444] rounded px-2 py-1.5 text-sm text-gray-300">
                        <option>æ‚¨æ¯äº²çš„å§“åæ˜¯ï¼Ÿ</option>
                        <option>æ‚¨å‡ºç”Ÿçš„åŸå¸‚æ˜¯ï¼Ÿ</option>
                    </select>
                    <input type="text" id="reg-answer" placeholder="å¯†ä¿ç­”æ¡ˆ" class="w-full bg-[#0f0f0f] border border-[#444] rounded px-3 py-2 text-white text-sm">
                    <div class="flex items-start gap-2 text-xs text-gray-400">
                        <input type="checkbox" id="agree-law" class="mt-0.5">
                        <label for="agree-law">åŒæ„<a href="#" onclick="showRules()" class="text-[#8B0000]">ã€Šç¤¾åŒºæ³•è§„ã€‹</a></label>
                    </div>
                    <button onclick="handleRegister()" class="btn-metal w-full py-2 rounded text-white font-bold">æ³¨å†Œ</button>
                </div>
            </div>
            <button onclick="closeAuth()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <!-- å‘å¸–æ¨¡æ€æ¡† -->
    <div id="post-modal" class="hidden fixed inset-0 z-[1000] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-[#1f1f1f] border border-[#444] rounded-lg w-full max-w-3xl max-h-[90vh] flex flex-col modal-enter">
            <div class="flex items-center justify-between p-4 border-b border-[#444]">
                <h3 class="font-bold text-white" id="post-modal-title">å‘å¸ƒæ–°å¸–</h3>
                <button onclick="closePostModal()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 space-y-3 overflow-y-auto flex-1">
                <input type="hidden" id="edit-post-id">
                <input type="text" id="post-title" placeholder="æ ‡é¢˜" class="w-full bg-[#0f0f0f] border border-[#444] rounded px-3 py-2 text-white">
                <textarea id="post-content" rows="10" placeholder="æ­£æ–‡..." class="w-full bg-[#0f0f0f] border border-[#444] rounded px-3 py-2 text-white resize-none"></textarea>
            </div>
            <div class="p-4 border-t border-[#444] flex justify-end gap-2">
                <button onclick="closePostModal()" class="btn-metal px-4 py-1.5 rounded text-sm">å–æ¶ˆ</button>
                <button onclick="submitPost()" class="btn-red px-6 py-1.5 rounded text-sm font-bold">å‘å¸ƒ</button>
            </div>
        </div>
    </div>

    <script>
        // ================= æ•°æ®å­˜å‚¨ =================
        const DB = {
            currentUser: null,
            presidentKey: false,
           Â 
            // å•†å“åº“
            shopItems: [
                {id: 'frame_gold', name: 'é‡‘è´¨å¤´åƒæ¡†', type: 'frame', price: 500, icon: 'ğŸ‘‘', desc: 'å°Šè´µé‡‘è‰²è¾¹æ¡†ï¼Œå½°æ˜¾ç«™é•¿æƒå¨ï¼ˆä»…è£…é¥°ï¼‰', style: 'avatar-frame-gold', permanent: true},
                {id: 'frame_silver', name: 'é“¶è´¨å¤´åƒæ¡†', type: 'frame', price: 300, icon: 'âš™ï¸', desc: 'å·¥ç¨‹å¸ˆä¸“å±é“¶è‰²è¾¹æ¡†', style: 'avatar-frame-silver', permanent: true},
                {id: 'frame_bronze', name: 'é“œè´¨å¤´åƒæ¡†', type: 'frame', price: 150, icon: 'ğŸ›¤ï¸', desc: 'èµ„æ·±è½¦è¿·é“œè‰²è¾¹æ¡†', style: 'avatar-frame-bronze', permanent: true},
                {id: 'frame_rail', name: 'é“è·¯çº¢è¾¹æ¡†', type: 'frame', price: 100, icon: 'ğŸš‚', desc: 'å¤§ç§¦çº¿ç»å…¸çº¢è‰²', style: 'avatar-frame-rail', permanent: true},
                {id: 'name_gold', name: 'é‡‘è‰²ID', type: 'namecolor', price: 200, icon: 'ğŸŸ¡', desc: 'åœŸè±ªé‡‘ç”¨æˆ·åæ˜¾ç¤º', style: 'name-gold', permanent: true},
                {id: 'name_red', name: 'èµ¤è‰²ID', type: 'namecolor', price: 200, icon: 'ğŸ”´', desc: 'é†’ç›®çº¢è‰²ç”¨æˆ·å', style: 'name-red', permanent: true},
                {id: 'badge_engineer', name: 'å·¥ç¨‹å¸ˆå‹‹ç« ', type: 'badge', price: 300, icon: 'âš™ï¸', desc: 'æŠ€æœ¯å¤§ç‰›æ ‡è¯†', badgeIcon: 'âš™ï¸', badgeColor: 'bg-gray-700', permanent: true},
                {id: 'badge_photographer', name: 'æ‘„å½±å¸ˆå‹‹ç« ', type: 'badge', price: 300, icon: 'ğŸ“·', desc: 'æ‘„å½±è¾¾äººæ ‡è¯†', badgeIcon: 'ğŸ“·', badgeColor: 'bg-purple-700', permanent: true},
                {id: 'badge_oldfan', name: 'è€å¸æœºå‹‹ç« ', type: 'badge', price: 500, icon: 'ğŸ–ï¸', desc: 'èµ„æ·±è½¦è¿·ä¸“å±', badgeIcon: 'ğŸ–ï¸', badgeColor: 'bg-[#8B0000]', permanent: true},
                {id: 'title_rebirth', name: 'ç§°å·ï¼šè½¬ç”Ÿè½¦è¿·', type: 'title', price: 1000, icon: 'ğŸŒŸ', desc: 'å°Šè´µèº«ä»½è±¡å¾ï¼Œæ˜¾ç¤ºåœ¨ç”¨æˆ·åæ—', permanent: true}
            ],
           Â 
            posts: [
                {id: 1, title: "ã€å…¬å‘Šã€‘ç¤¾åŒºæ³•è§„æ›´æ–°é€šçŸ¥", content: "å„ä½è½¦è¿·æœ‹å‹ï¼š\n\nä¸ºäº†ç»´æŠ¤ç¤¾åŒºè‰¯å¥½çš„æŠ€æœ¯äº¤æµæ°›å›´ï¼Œç°å°†æ³•è§„æ›´æ–°å¦‚ä¸‹ï¼š\n\n1. ä¸¥ç¦å‘å¸ƒæ¶‰å¯†é“è·¯ä¿¡æ¯\n2. æŠ€æœ¯è®¨è®ºè¯·ä¿æŒå‹å–„æ€åº¦\n3. æ‘„å½±ä½œå“è¯·æ ‡æ³¨æ‹æ‘„åœ°ç‚¹å’Œå®‰å…¨æç¤º\n\nè¿åä»¥ä¸Šè§„å®šè€…ï¼ŒæŒ‰ã€Šä¿¡æ¯ç³»ç»Ÿå®‰å…¨ä¿æŠ¤æ¡ä¾‹ã€‹å¤„ç†ã€‚\n\nå±±è¥¿çœæ™‹åŒ—ç•…è¡Œäº¤é€šæ–‡åŒ–ç¤¾\n2025å¹´1æœˆ31æ—¥", author: "system", authorName: "ç®¡ç†å‘˜", type: "å…¬å‘Š", isSticky: true, createTime: "2025-01-31 10:00", views: 1200, replies: 5, authorAvatar: null, rewards: 0},
                {id: 2, title: "HXD1å‹æœºè½¦æŠ€æœ¯è®¨è®º", content: "æœ€è¿‘ç ”ç©¶äº†HXD1å‹ç”µåŠ›æœºè½¦çš„ç‰µå¼•ç³»ç»Ÿï¼Œæƒ³å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹å¿ƒå¾—ï¼š\n\nè¿™æ¬¾æœºè½¦é‡‡ç”¨äº¤ç›´äº¤ä¼ åŠ¨ï¼ŒåŠŸç‡è¾¾åˆ°9600kWï¼Œæ˜¯ç›®å‰é‡è½½è¿è¾“çš„ä¸»åŠ›æœºå‹ã€‚\n\næœ‰å‡ ä¸ªé—®é¢˜æƒ³è¯·æ•™ï¼š\n1. å†ç”Ÿåˆ¶åŠ¨æ•ˆç‡åœ¨å®é™…è¿ç”¨ä¸­å¦‚ä½•ï¼Ÿ\n2. ç‰µå¼•å˜æµå™¨çš„å†·å´ç³»ç»Ÿç»´æŠ¤å‘¨æœŸæ˜¯å¤šä¹…ï¼Ÿ\n\næœŸå¾…å„ä½åŒè¡Œè€å¸ˆå‚…æŒ‡ç‚¹ï¼", author: "user001", authorName: "é“é“è¿·å°æ", type: "æŠ€æœ¯", isSticky: false, createTime: "2025-01-31 14:30", views: 456, replies: 23, authorAvatar: null, rewards: 0}
            ],
           Â 
            users: {
                'user001': {Â 
                    username: 'user001',Â 
                    password: '123456',Â 
                    security: 'ä¿å¯†',Â 
                    role: 'user',Â 
                    points: 250,
                    avatar: null,
                    inventory: [],
                    equipped: {frame: null, namecolor: null, badges: []}
                },
                'Wunji': {Â 
                    username: 'Wunji',Â 
                    password: '1234578wW',Â 
                    security: '20121126',Â 
                    role: 'president',Â 
                    points: Infinity, // æ— é™ç§¯åˆ†
                    avatar: null,
                    inventory: ['frame_gold', 'badge_oldfan', 'name_gold'],
                    equipped: {frame: 'frame_gold', namecolor: 'name_gold', badges: ['badge_oldfan']}
                }
            }
        };

        let tempAvatarData = null;
        let currentRewardPostId = null;
        let selectedRewardAmount = 0;
        let expandedPostId = null; // è®°å½•å½“å‰å±•å¼€çš„å¸–å­ID

        // ================= åˆå§‹åŒ– =================
        document.addEventListener('DOMContentLoaded', () => {
            updateTime();
            setInterval(updateTime, 1000);
            renderPosts();
            updateStats();
        });

        function updateTime() {
            const now = new Date();
            document.getElementById('beijing-time').textContent = now.toLocaleString('zh-CN', {hour12: false});
        }

        function updateStats() {
            document.getElementById('stat-posts').textContent = DB.posts.length;
        }

        // ================= æ— é™ç§¯åˆ†ç³»ç»Ÿ =================
       Â 
        // æ£€æŸ¥æ˜¯å¦ä¸ºä¼šé•¿ï¼ˆæ— é™ç§¯åˆ†ï¼‰
        function isPresident() {
            return DB.currentUser && DB.currentUser.role === 'president';
        }

        // è·å–æ˜¾ç¤ºçš„ç§¯åˆ†æ–‡æœ¬
        function getDisplayPoints(user = DB.currentUser) {
            if (!user) return '0';
            if (user.role === 'president') return 'âˆ';
            return user.points;
        }

        // æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿï¼ˆä¼šé•¿æ°¸è¿œè¿”å›trueï¼‰
        function hasEnoughPoints(amount) {
            if (isPresident()) return true;
            return DB.currentUser && DB.currentUser.points >= amount;
        }

        // ä¿®æ”¹ç§¯åˆ†ï¼ˆä¼šé•¿ä¸æ‰£å‡ï¼Œåªåšè®°å½•ï¼‰
        function modifyPoints(amount, reason = '', targetUser = null) {
            const user = targetUser || DB.currentUser;
            if (!user) return;
           Â 
            const isPres = user.role === 'president';
            const isCurrent = user === DB.currentUser;
           Â 
            // å¦‚æœä¸æ˜¯ä¼šé•¿ï¼Œæˆ–è€…ç›®æ ‡æ˜¯å…¶ä»–ç”¨æˆ·ï¼ˆç®¡ç†æ“ä½œï¼‰ï¼Œåˆ™æ­£å¸¸ä¿®æ”¹ç§¯åˆ†
            if (!isPres || (targetUser && targetUser !== DB.currentUser)) {
                user.points += amount;
                if (user.points < 0) user.points = 0;
            } else if (isPres && isCurrent && amount < 0) {
                // ä¼šé•¿æ¶ˆè´¹ï¼Œè®°å½•ä½†ä¸æ‰£å‡
                console.log(`[æ— é™ç§¯åˆ†æ¶ˆè´¹] ${reason || 'æ¶ˆè´¹'}: ${Math.abs(amount)}ï¼Œå®é™…æœªæ‰£å‡`);
            }
           Â 
            // æ›´æ–°UI
            if (isCurrent) {
                updatePointsDisplay();
               Â 
                // æµ®åŠ¨åŠ¨ç”»ï¼ˆåªæœ‰å®é™…æ‰£å‡ç§¯åˆ†çš„ç”¨æˆ·æ˜¾ç¤ºï¼‰
                if (amount !== 0 && !isPres) {
                    showPointsFloat(amount);
                    if (reason) showToast(`${reason} ${amount > 0 ? '+' : ''}${amount}ç§¯åˆ†`, amount > 0 ? 'success' : 'info');
                } else if (isPres && amount < 0) {
                    showToast(`${reason} ${Math.abs(amount)}ç§¯åˆ†ï¼ˆå…æ‰£ï¼‰`, 'info');
                }
            }
        }

        function showPointsFloat(amount) {
            const floatEl = document.createElement('div');
            floatEl.className = 'points-float';
            floatEl.textContent = amount > 0 ? `+${amount}` : `${amount}`;
            floatEl.style.left = '50%';
            floatEl.style.top = '50%';
            document.body.appendChild(floatEl);
            setTimeout(() => floatEl.remove(), 1000);
        }

        // æ›´æ–°æ‰€æœ‰ç§¯åˆ†æ˜¾ç¤ºä½ç½®
        function updatePointsDisplay() {
            const display = getDisplayPoints();
            const els = ['nav-points', 'sidebar-points', 'shop-points'];
            els.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = display;
            });
        }

        // ================= æ‰“èµç³»ç»Ÿ =================

        // æ‰“å¼€æ‰“èµæ¨¡æ€æ¡†
        function openRewardModal(postId) {
            if (!DB.currentUser) {
                showAuth();
                return;
            }
           Â 
            const post = DB.posts.find(p => p.id === postId);
            if (!post) return;
           Â 
            // ä¸èƒ½æ‰“èµè‡ªå·±
            if (post.author === DB.currentUser.username) {
                showToast('ä¸èƒ½æ‰“èµè‡ªå·±çš„å¸–å­', 'error');
                return;
            }
           Â 
            currentRewardPostId = postId;
            document.getElementById('reward-target-name').textContent = post.authorName;
            document.getElementById('reward-modal').classList.remove('hidden');
           Â 
            // é‡ç½®é€‰æ‹©
            selectedRewardAmount = 0;
            updateRewardCalculation();
            document.querySelectorAll('.reward-btn').forEach(btn => {
                btn.classList.remove('border-[#DAA520]', 'bg-[#DAA520]/20');
                btn.classList.add('border-[#444]');
            });
            document.getElementById('reward-custom-amount').value = '';
            document.getElementById('reward-submit-btn').disabled = true;
            document.getElementById('reward-submit-btn').classList.add('opacity-50', 'cursor-not-allowed');
        }

        function closeRewardModal() {
            document.getElementById('reward-modal').classList.add('hidden');
            currentRewardPostId = null;
            selectedRewardAmount = 0;
        }

        function selectRewardAmount(amount) {
            selectedRewardAmount = amount;
            document.getElementById('reward-custom-amount').value = '';
           Â 
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.querySelectorAll('.reward-btn').forEach(btn => {
                const btnAmount = parseInt(btn.dataset.amount);
                if (btnAmount === amount) {
                    btn.classList.add('border-[#DAA520]', 'bg-[#DAA520]/20');
                    btn.classList.remove('border-[#444]');
                } else {
                    btn.classList.remove('border-[#DAA520]', 'bg-[#DAA520]/20');
                    btn.classList.add('border-[#444]');
                }
            });
           Â 
            updateRewardCalculation();
            enableRewardBtn();
        }

        // ç›‘å¬è‡ªå®šä¹‰é‡‘é¢è¾“å…¥
        document.addEventListener('DOMContentLoaded', () => {
            const customInput = document.getElementById('reward-custom-amount');
            if (customInput) {
                customInput.addEventListener('input', function(e) {
                    const val = parseInt(e.target.value);
                    if (val >= 10 && val % 10 === 0) {
                        selectedRewardAmount = val;
                        // æ¸…é™¤é¢„è®¾æŒ‰é’®é€‰ä¸­çŠ¶æ€
                        document.querySelectorAll('.reward-btn').forEach(btn => {
                            btn.classList.remove('border-[#DAA520]', 'bg-[#DAA520]/20');
                            btn.classList.add('border-[#444]');
                        });
                        updateRewardCalculation();
                        enableRewardBtn();
                    } else {
                        selectedRewardAmount = 0;
                        updateRewardCalculation();
                        disableRewardBtn();
                    }
                });
            }
        });

        function updateRewardCalculation() {
            const pay = selectedRewardAmount;
            const get = Math.floor(pay / 10); // 10ç§¯åˆ†=1ç§¯åˆ†
            const fee = pay - get;
           Â 
            document.getElementById('reward-pay').textContent = pay + ' ç§¯åˆ†';
            document.getElementById('reward-get').textContent = get + ' ç§¯åˆ†';
            document.getElementById('reward-fee').textContent = fee + ' ç§¯åˆ†';
        }

        function enableRewardBtn() {
            const btn = document.getElementById('reward-submit-btn');
            if (selectedRewardAmount >= 10) {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function disableRewardBtn() {
            const btn = document.getElementById('reward-submit-btn');
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        function submitReward() {
            if (!currentRewardPostId || selectedRewardAmount < 10) return;
           Â 
            const post = DB.posts.find(p => p.id === currentRewardPostId);
            if (!post) return;
           Â 
            // æ£€æŸ¥ä½™é¢ï¼ˆä¼šé•¿è·³è¿‡ï¼‰
            if (!isPresident() && DB.currentUser.points < selectedRewardAmount) {
                showToast('ç§¯åˆ†ä¸è¶³', 'error');
                return;
            }
           Â 
            const authorData = DB.users[post.author];
            const rewardToAuthor = Math.floor(selectedRewardAmount / 10);
           Â 
            // æ‰£é™¤æ‰“èµè€…ç§¯åˆ†ï¼ˆä¼šé•¿ä¸æ‰£ï¼‰
            modifyPoints(-selectedRewardAmount, 'æ‰“èµå¸–å­');
           Â 
            // å¢åŠ ä½œè€…ç§¯åˆ†
            if (authorData) {
                authorData.points += rewardToAuthor;
                // å¦‚æœä½œè€…æ˜¯å½“å‰ç™»å½•ç”¨æˆ·ï¼Œæ›´æ–°æ˜¾ç¤º
                if (authorData === DB.currentUser) {
                    updatePointsDisplay();
                }
            }
           Â 
            // å¢åŠ å¸–å­æ‰“èµæ•°
            post.rewards = (post.rewards || 0) + 1;
           Â 
            showToast(`æ‰“èµæˆåŠŸï¼${post.authorName} è·å¾— ${rewardToAuthor} ç§¯åˆ†`, 'success');
            closeRewardModal();
            renderPosts();
        }

        // ================= å•†åŸç³»ç»Ÿï¼ˆæ”¯æŒæ— é™ç§¯åˆ†ï¼‰ =================

        function buyItem(itemId) {
            if (!DB.currentUser) {
                showToast('è¯·å…ˆç™»å½•', 'error');
                return;
            }
           Â 
            const item = DB.shopItems.find(i => i.id === itemId);
            if (!item) return;
           Â 
            // æ£€æŸ¥æ˜¯å¦å·²æ‹¥æœ‰
            if (DB.currentUser.inventory.includes(itemId)) {
                showToast('æ‚¨å·²æ‹¥æœ‰æ­¤ç‰©å“', 'warning');
                return;
            }
           Â 
            // æ£€æŸ¥ç§¯åˆ†ï¼ˆéä¼šé•¿éœ€è¦æ£€æŸ¥ï¼‰
            if (!isPresident() && DB.currentUser.points < item.price) {
                showToast(`ç§¯åˆ†ä¸è¶³ï¼Œéœ€è¦${item.price}ç§¯åˆ†`, 'error');
                return;
            }
           Â 
            // ç¡®è®¤è´­ä¹°
            const confirmMsg = isPresident() ?Â 
                `ç¡®è®¤å…è´¹è´­ä¹°ã€${item.name}ã€‘ï¼Ÿ\n\n${item.desc}\n\nï¼ˆä¼šé•¿æ— é™ç§¯åˆ†ç‰¹æƒï¼‰` :
                `ç¡®è®¤èŠ±è´¹ ${item.price} ç§¯åˆ†è´­ä¹°ã€${item.name}ã€‘ï¼Ÿ\n\n${item.desc}`;
           Â 
            if (!confirm(confirmMsg)) return;
           Â 
            // æ‰£ç§¯åˆ†ï¼ˆä¼šé•¿ä¸æ‰£ï¼‰
            modifyPoints(-item.price, 'è´­ä¹°' + item.name);
           Â 
            // åŠ å…¥èƒŒåŒ…
            DB.currentUser.inventory.push(itemId);
           Â 
            // è‡ªåŠ¨è£…å¤‡é€»è¾‘
            let equipped = false;
            if (item.type === 'frame' && !DB.currentUser.equipped.frame) {
                DB.currentUser.equipped.frame = itemId;
                equipped = true;
            } else if (item.type === 'namecolor' && !DB.currentUser.equipped.namecolor) {
                DB.currentUser.equipped.namecolor = itemId;
                equipped = true;
            } else if (item.type === 'badge' && DB.currentUser.equipped.badges.length === 0) {
                DB.currentUser.equipped.badges.push(itemId);
                equipped = true;
            }
           Â 
            showToast(equipped ? 'è´­ä¹°æˆåŠŸï¼å·²è‡ªåŠ¨è£…å¤‡' : 'è´­ä¹°æˆåŠŸï¼è¯·åˆ°èƒŒåŒ…è£…å¤‡', 'success');
           Â 
            renderShop();
            renderInventory();
            renderPosts();
            document.getElementById('user-item-count').textContent = DB.currentUser.inventory.length;
        }

        function toggleEquip(itemId) {
            const item = DB.shopItems.find(i => i.id === itemId);
            if (!item || !DB.currentUser.inventory.includes(itemId)) return;
           Â 
            if (item.type === 'frame') {
                DB.currentUser.equipped.frame = DB.currentUser.equipped.frame === itemId ? null : itemId;
            } else if (item.type === 'namecolor') {
                DB.currentUser.equipped.namecolor = DB.currentUser.equipped.namecolor === itemId ? null : itemId;
            } else if (item.type === 'badge') {
                const idx = DB.currentUser.equipped.badges.indexOf(itemId);
                if (idx > -1) DB.currentUser.equipped.badges.splice(idx, 1);
                else DB.currentUser.equipped.badges.push(itemId);
            }
           Â 
            renderInventory();
            renderInventoryDetail();
            renderPosts();
            showToast('è£…å¤‡å·²æ›´æ–°', 'success');
        }

        // ================= UI å‡½æ•° =================

        function openShop() {
            if (!DB.currentUser) {
                showAuth();
                return;
            }
            document.getElementById('shop-modal').classList.remove('hidden');
            updatePointsDisplay();
            renderShop();
            renderInventory();
        }

        function closeShop() {
            document.getElementById('shop-modal').classList.add('hidden');
        }

        function renderShop() {
            const container = document.getElementById('shop-items');
            container.innerHTML = '';
           Â 
            DB.shopItems.forEach(item => {
                const isOwned = DB.currentUser.inventory.includes(item.id);
                const canAfford = isPresident() || DB.currentUser.points >= item.price;
               Â 
                const div = document.createElement('div');
                div.className = `shop-item rounded-lg p-4 flex flex-col ${isOwned ? 'opacity-60' : ''}`;
               Â 
                // ä¼šé•¿æ˜¾ç¤º"å…è´¹"è€Œä¸æ˜¯ä»·æ ¼
                const priceDisplay = isPresident() ?Â 
                    '<span class="text-[#DAA520] font-bold text-xs">[ä¼šé•¿å…è´¹]</span>' :
                    `<div class="flex items-center gap-1 text-[#DAA520] font-bold"><i class="fas fa-coins text-xs"></i><span>${item.price}</span></div>`;
               Â 
                div.innerHTML = `
                    <div class="text-3xl mb-2 text-center">${item.icon}</div>
                    <h4 class="font-bold text-white text-sm mb-1 text-center">${item.name}</h4>
                    <p class="text-xs text-gray-500 mb-3 text-center h-8 overflow-hidden">${item.desc}</p>
                    <div class="mt-auto flex items-center justify-between">
                        ${priceDisplay}
                        <button onclick="${isOwned ? '' : `buyItem('${item.id}')`}"Â 
                                class="px-3 py-1.5 rounded text-xs font-bold ${isOwned ? 'bg-gray-700 text-gray-400 cursor-not-allowed' : canAfford ? 'btn-gold' : 'bg-gray-700 text-gray-400 cursor-not-allowed'}"
                                ${isOwned || !canAfford ? 'disabled' : ''}>
                            ${isOwned ? 'å·²æ‹¥æœ‰' : canAfford ? 'è´­ä¹°' : 'ç§¯åˆ†ä¸è¶³'}
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderInventory() {
            const list = document.getElementById('inventory-list');
            if (DB.currentUser.inventory.length === 0) {
                list.innerHTML = '<p class="text-xs text-gray-500 text-center py-4">æš‚æ— è£…é¥°å“</p>';
                return;
            }
           Â 
            list.innerHTML = DB.currentUser.inventory.map(itemId => {
                const item = DB.shopItems.find(i => i.id === itemId);
                if (!item) return '';
               Â 
                let isEquipped = false;
                if (item.type === 'frame') isEquipped = DB.currentUser.equipped.frame === itemId;
                else if (item.type === 'namecolor') isEquipped = DB.currentUser.equipped.namecolor === itemId;
                else if (item.type === 'badge') isEquipped = DB.currentUser.equipped.badges.includes(itemId);
               Â 
                return `
                    <div class="inventory-item ${isEquipped ? 'equipped' : ''} p-2 rounded flex items-center gap-2 cursor-pointer" onclick="toggleEquip('${item.id}')">
                        <span class="text-lg">${item.icon}</span>
                        <div class="flex-1 min-w-0">
                            <div class="text-xs text-white truncate">${item.name}</div>
                            <div class="text-[10px] text-gray-500">${isEquipped ? 'å·²è£…å¤‡' : 'ç‚¹å‡»è£…å¤‡'}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openInventory() {
            if (!DB.currentUser) {
                showAuth();
                return;
            }
            document.getElementById('inventory-modal').classList.remove('hidden');
            renderInventoryDetail();
            updatePreview();
        }

        function renderInventoryDetail() {
            const detailList = document.getElementById('inventory-detail-list');
            if (DB.currentUser.inventory.length === 0) {
                detailList.innerHTML = '<div class="col-span-3 text-center text-gray-500 py-8">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»å•†åŸå…‘æ¢å§ï¼</div>';
            } else {
                detailList.innerHTML = DB.currentUser.inventory.map(itemId => {
                    const item = DB.shopItems.find(i => i.id === itemId);
                    if (!item) return '';
                   Â 
                    let isEquipped = false;
                    if (item.type === 'frame') isEquipped = DB.currentUser.equipped.frame === itemId;
                    else if (item.type === 'namecolor') isEquipped = DB.currentUser.equipped.namecolor === itemId;
                    else if (item.type === 'badge') isEquipped = DB.currentUser.equipped.badges.includes(itemId);
                   Â 
                    return `
                        <div class="bg-[#1a1a1a] border ${isEquipped ? 'border-[#DAA520] bg-[#DAA520]/10' : 'border-[#333]'} rounded-lg p-4 cursor-pointer hover:border-[#DAA520]/50 transition-colors" onclick="toggleEquip('${item.id}')">
                            <div class="text-3xl text-center mb-2">${item.icon}</div>
                            <div class="text-sm font-bold text-white text-center mb-1">${item.name}</div>
                            <div class="text-xs text-gray-500 text-center mb-2">${item.desc}</div>
                            <div class="text-center">
                                <span class="text-xs px-2 py-1 rounded ${isEquipped ? 'bg-[#DAA520] text-black' : 'bg-[#333] text-gray-400'}">
                                    ${isEquipped ? 'å·²è£…å¤‡' : 'æœªè£…å¤‡'}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            document.getElementById('user-item-count').textContent = DB.currentUser.inventory.length;
        }

        function updatePreview() {
            if (!DB.currentUser) return;
           Â 
            const avatar = DB.currentUser.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${DB.currentUser.username}`;
            document.getElementById('preview-avatar').src = avatar;
           Â 
            const frameDiv = document.getElementById('preview-frame');
            frameDiv.className = 'absolute inset-0 rounded-full pointer-events-none';
            if (DB.currentUser.equipped.frame) {
                const frameItem = DB.shopItems.find(i => i.id === DB.currentUser.equipped.frame);
                if (frameItem) frameDiv.classList.add(frameItem.style);
            }
           Â 
            const nameDiv = document.getElementById('preview-username');
            nameDiv.textContent = DB.currentUser.username;
            nameDiv.className = 'font-bold';
            if (DB.currentUser.equipped.namecolor) {
                const colorItem = DB.shopItems.find(i => i.id === DB.currentUser.equipped.namecolor);
                if (colorItem) nameDiv.classList.add(colorItem.style);
            } else {
                nameDiv.classList.add('text-white');
            }
           Â 
            const badgesDiv = document.getElementById('preview-badges');
            badgesDiv.innerHTML = DB.currentUser.equipped.badges.map(badgeId => {
                const badge = DB.shopItems.find(i => i.id === badgeId);
                return `<div class="badge ${badge.badgeColor} text-white" data-title="${badge.name}">${badge.badgeIcon}</div>`;
            }).join('');
        }

        function closeInventory() {
            document.getElementById('inventory-modal').classList.add('hidden');
        }

        // ================= å¸–å­ç³»ç»Ÿï¼ˆå·²æ·»åŠ æ­£æ–‡æŸ¥çœ‹åŠŸèƒ½ï¼‰ =================

        // åˆ‡æ¢å¸–å­å±•å¼€/æ”¶èµ·
        function togglePostContent(postId) {
            const contentDiv = document.getElementById(`post-content-${postId}`);
            const rowDiv = document.getElementById(`post-row-${postId}`);
           Â 
            if (expandedPostId === postId) {
                // æ”¶èµ·
                contentDiv.classList.remove('expanded');
                rowDiv.classList.remove('expanded');
                expandedPostId = null;
            } else {
                // æ”¶èµ·å…¶ä»–å·²å±•å¼€çš„å¸–å­
                if (expandedPostId) {
                    const prevContent = document.getElementById(`post-content-${expandedPostId}`);
                    const prevRow = document.getElementById(`post-row-${expandedPostId}`);
                    if (prevContent) prevContent.classList.remove('expanded');
                    if (prevRow) prevRow.classList.remove('expanded');
                }
               Â 
                // å±•å¼€å½“å‰å¸–å­
                contentDiv.classList.add('expanded');
                rowDiv.classList.add('expanded');
                expandedPostId = postId;
               Â 
                // å¢åŠ æµè§ˆé‡
                const post = DB.posts.find(p => p.id === postId);
                if (post && !post.viewed) {
                    post.views++;
                    post.viewed = true; // æ ‡è®°å·²æµè§ˆï¼Œé¿å…é‡å¤è®¡æ•°
                    renderPosts();
                }
            }
        }

        function renderPosts() {
            const stickyList = document.getElementById('sticky-list');
            const normalList = document.getElementById('thread-list');
            stickyList.innerHTML = '';
            normalList.innerHTML = '';
           Â 
            DB.posts.forEach(post => {
                const isAuthor = DB.currentUser && DB.currentUser.username === post.author;
                const isPresident = DB.currentUser && DB.currentUser.role === 'president';
                const canEdit = isAuthor || isPresident;
                const canDelete = isAuthor || isPresident;
                const isExpanded = expandedPostId === post.id;
               Â 
                const authorData = DB.users[post.author];
                let nameClass = 'text-gray-400';
                let frameClass = '';
                let badgesHtml = '';
               Â 
                if (authorData) {
                    if (authorData.equipped.namecolor) {
                        const colorItem = DB.shopItems.find(i => i.id === authorData.equipped.namecolor);
                        if (colorItem) nameClass = colorItem.style;
                    }
                    if (authorData.equipped.frame) {
                        const frameItem = DB.shopItems.find(i => i.id === authorData.equipped.frame);
                        if (frameItem) frameClass = frameItem.style;
                    }
                    if (authorData.equipped.badges && authorData.equipped.badges.length > 0) {
                        badgesHtml = authorData.equipped.badges.map(bid => {
                            const badge = DB.shopItems.find(i => i.id === bid);
                            return `<div class="badge ${badge.badgeColor} text-white" data-title="${badge.name}">${badge.badgeIcon}</div>`;
                        }).join('');
                    }
                }
               Â 
                let actions = '';
                if (canEdit || canDelete) {
                    actions = `<div class="flex gap-2 ${isPresident ? 'president-only' : 'author-only'}">`;
                    if (canEdit) actions += `<button onclick="event.stopPropagation(); editPost(${post.id})" class="text-xs px-2 py-1 bg-[#4169E1] rounded text-white">${isPresident && !isAuthor ? 'ä¿®æ”¹' : 'ç¼–è¾‘'}</button>`;
                    if (canDelete) actions += `<button onclick="event.stopPropagation(); deletePost(${post.id})" class="text-xs px-2 py-1 ${isPresident && !isAuthor ? 'bg-red-600' : 'bg-[#8B0000]'} rounded text-white">${isPresident && !isAuthor ? 'å¼ºåˆ¶åˆ é™¤' : 'åˆ é™¤'}</button>`;
                    if (isPresident && !post.isSticky) actions += `<button onclick="event.stopPropagation(); stickyPost(${post.id})" class="text-xs px-2 py-1 bg-[#DAA520] rounded text-black font-bold">ç½®é¡¶</button>`;
                    else if (isPresident && post.isSticky) actions += `<button onclick="event.stopPropagation(); unstickyPost(${post.id})" class="text-xs px-2 py-1 bg-[#333] rounded text-white">å–æ¶ˆç½®é¡¶</button>`;
                    actions += '</div>';
                }
               Â 
                // æ‰“èµæŒ‰é’®ï¼ˆéä½œè€…å¯è§ï¼‰
                let rewardBtn = '';
                if (DB.currentUser && !isAuthor) {
                    const rewardCount = post.rewards || 0;
                    rewardBtn = `
                        <button onclick="event.stopPropagation(); openRewardModal(${post.id})" class="flex items-center gap-1 text-xs text-[#DAA520] hover:text-[#FFD700] bg-[#DAA520]/10 hover:bg-[#DAA520]/20 px-2 py-1 rounded transition-colors ml-2" title="æ‰“èµ">
                            <i class="fas fa-gift"></i>
                            <span>${rewardCount > 0 ? rewardCount : 'æ‰“èµ'}</span>
                        </button>
                    `;
                } else if (!DB.currentUser) {
                    rewardBtn = `
                        <button onclick="event.stopPropagation(); showAuth()" class="flex items-center gap-1 text-xs text-gray-500 hover:text-[#DAA520] bg-[#333] hover:bg-[#444] px-2 py-1 rounded transition-colors ml-2">
                            <i class="fas fa-gift"></i>
                            <span>ç™»å½•åæ‰“èµ</span>
                        </button>
                    `;
                } else {
                    // ä½œè€…çœ‹åˆ°è‡ªå·±çš„å¸–å­æ˜¾ç¤ºæ‰“èµæ•°ä½†ä¸å¯ç‚¹å‡»
                    const rewardCount = post.rewards || 0;
                    if (rewardCount > 0) {
                        rewardBtn = `<span class="flex items-center gap-1 text-xs text-[#DAA520] px-2 py-1 ml-2"><i class="fas fa-gift"></i>${rewardCount}</span>`;
                    }
                }
               Â 
                const row = document.createElement('div');
                row.className = `forum-row p-4 ${post.isSticky ? 'sticky-top' : ''} ${isExpanded ? 'expanded' : ''} cursor-pointer`;
                row.id = `post-row-${post.id}`;
                row.dataset.threadId = post.id;
                row.dataset.isAuthor = isAuthor;
                row.onclick = () => togglePostContent(post.id);
               Â 
                const avatarUrl = post.authorAvatar || (authorData && authorData.avatar) || `https://api.dicebear.com/7.x/avataaars/svg?seed=${post.author}`;
               Â 
                row.innerHTML = `
                    <div class="flex justify-between items-start gap-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                ${post.isSticky ? '<i class="fas fa-thumbtack text-[#DAA520] text-xs"></i>' : ''}
                                <span class="text-xs border border-current px-1 rounded ${post.type === 'æŠ€æœ¯' ? 'text-blue-400' : post.type === 'å…¬å‘Š' ? 'text-[#DAA520]' : 'text-gray-400'}">${post.type}</span>
                                <h3 class="font-medium truncate hover:text-[#DAA520] text-white flex items-center gap-2">
                                    ${post.title}
                                    <i class="fas fa-chevron-down text-xs text-gray-500 expand-indicator transition-transform ${isExpanded ? 'rotate-180' : ''}"></i>
                                </h3>
                            </div>
                            <div class="flex items-center gap-3 text-xs text-gray-500 flex-wrap">
                                <div class="relative">
                                    <img src="${avatarUrl}" class="w-5 h-5 rounded-full object-cover bg-[#333] ${frameClass}">
                                </div>
                                <span class="${nameClass} font-bold">${post.authorName}</span>
                                ${badgesHtml}
                                <span>${post.createTime}</span>
                                <span><i class="far fa-eye"></i> ${post.views}</span>
                                <span><i class="far fa-comment"></i> ${post.replies}</span>
                                ${rewardBtn}
                            </div>
                           Â 
                            <!-- å¸–å­æ­£æ–‡å†…å®¹åŒºåŸŸ -->
                            <div id="post-content-${post.id}" class="post-content ${isExpanded ? 'expanded' : ''}" onclick="event.stopPropagation()">
                                <div class="post-content-text bg-[#0f0f0f] p-4 rounded border border-[#333] mt-2 relative">
                                    ${post.content}
                                    <div class="absolute top-2 right-2 text-xs text-gray-600">
                                        <i class="fas fa-clock mr-1"></i>${post.createTime}
                                    </div>
                                </div>
                                <div class="flex justify-between items-center mt-3">
                                    <div class="text-xs text-gray-500">
                                        ç‚¹å‡»æ ‡é¢˜å¯æ”¶èµ·å†…å®¹
                                    </div>
                                    <div class="flex gap-2">
                                        ${isAuthor ? '<span class="text-xs text-[#8B0000] border border-[#8B0000] px-2 py-1 rounded">æˆ‘çš„å¸–å­</span>' : ''}
                                        ${post.isSticky ? '<span class="text-xs text-[#DAA520] border border-[#DAA520] px-2 py-1 rounded">ç½®é¡¶</span>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                        ${actions}
                    </div>
                `;
               Â 
                if (post.isSticky) stickyList.appendChild(row);
                else normalList.appendChild(row);
            });
        }

        function submitPost() {
            const title = document.getElementById('post-title').value.trim();
            const content = document.getElementById('post-content').value.trim();
            const editId = document.getElementById('edit-post-id').value;
           Â 
            if (!title || !content) {
                showToast('æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
           Â 
            if (editId) {
                const post = DB.posts.find(p => p.id == editId);
                if (post && (post.author === DB.currentUser.username || DB.currentUser.role === 'president')) {
                    post.title = title;
                    post.content = content;
                    showToast('ä¿®æ”¹æˆåŠŸ', 'success');
                }
            } else {
                const newPost = {
                    id: Date.now(),
                    title: title,
                    content: content,
                    author: DB.currentUser.username,
                    authorName: DB.currentUser.username,
                    type: 'è®¨è®º',
                    isSticky: false,
                    createTime: new Date().toLocaleString('zh-CN', {hour12: false}),
                    views: 0,
                    replies: 0,
                    authorAvatar: DB.currentUser.avatar,
                    rewards: 0
                };
                DB.posts.unshift(newPost);
               Â 
                modifyPoints(10, 'å‘å¸ƒå¸–å­');
                showToast('å‘å¸ƒæˆåŠŸï¼Œè·å¾—10ç§¯åˆ†ï¼', 'success');
            }
           Â 
            closePostModal();
            renderPosts();
            updateStats();
        }

        // ================= åŸæœ‰ç³»ç»Ÿ =================

        let secretClickCount = 0;
        let lastClickTime = 0;
        function handleSecretTrigger() {
            const now = Date.now();
            if (now - lastClickTime > 2000) secretClickCount = 0;
            lastClickTime = now;
            secretClickCount++;
            if (secretClickCount === 5) activatePresidentLogin();
        }
       Â 
        let shiftPCount = 0;
        let shiftPTimer = null;
        document.addEventListener('keydown', (e) => {
            if (e.shiftKey && e.key === 'P') {
                shiftPCount++;
                if (!shiftPTimer) shiftPTimer = setTimeout(() => { shiftPCount = 0; shiftPTimer = null; }, 3000);
                if (shiftPCount === 3) { activatePresidentLogin(); shiftPCount = 0; clearTimeout(shiftPTimer); shiftPTimer = null; }
            }
        });

        function activatePresidentLogin() {
            DB.presidentKey = true;
            document.getElementById('president-question').classList.remove('hidden');
            document.getElementById('login-question').value = 'president';
            showToast('âš ï¸ æ£€æµ‹åˆ°ç®¡ç†å‘˜å¯†é’¥', 'warning');
        }

        function handleLogin() {
            const user = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;
            const security = document.getElementById('login-security').value;
            const question = document.getElementById('login-question').value;
           Â 
            if (!user || !pass || !security) { showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error'); return; }
           Â 
            if (question === 'president' && DB.presidentKey) {
                if (user === 'Wunji' && pass === '1234578wW' && security === '20121126') {
                    loginSuccess(DB.users['Wunji']);
                    showToast('ğŸ‘‘ ç®¡ç†å‘˜ç™»å½•æˆåŠŸï¼ˆæ— é™ç§¯åˆ†æ¨¡å¼ï¼‰', 'success');
                    return;
                } else { showToast('ç®¡ç†å‘˜éªŒè¯å¤±è´¥', 'error'); return; }
            }
           Â 
            const userData = DB.users[user];
            if (userData && userData.password === pass && userData.security === security) {
                loginSuccess(userData);
                showToast('ç™»å½•æˆåŠŸ', 'success');
            } else { showToast('è´¦å·ã€å¯†ç æˆ–å¯†ä¿é”™è¯¯', 'error'); }
        }

        function loginSuccess(userData) {
            DB.currentUser = userData;
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('guest-state').classList.add('hidden');
            document.getElementById('user-state').classList.remove('hidden');
            document.getElementById('nav-username').textContent = userData.username;
            document.getElementById('sidebar-profile').classList.remove('hidden');
            document.getElementById('sidebar-username').textContent = userData.username;
            document.getElementById('sidebar-role').textContent = userData.role === 'president' ? 'ç®¡ç†å‘˜' : 'æ³¨å†Œç”¨æˆ·';
            updatePointsDisplay();
            document.getElementById('user-post-count').textContent = DB.posts.filter(p => p.author === userData.username).length;
            document.getElementById('user-item-count').textContent = userData.inventory ? userData.inventory.length : 0;
           Â 
            updateAvatarDisplay();
           Â 
            if (userData.role === 'president') {
                document.body.classList.add('president-mode');
                // ä¼šé•¿ç™»å½•æç¤º
                setTimeout(() => {
                    showToast('ğŸ’° æ— é™ç§¯åˆ†ç‰¹æƒå·²æ¿€æ´»ï¼šä»»æ„æ¶ˆè´¹ä¸æ‰£ç§¯åˆ†', 'success');
                }, 1000);
            }
            renderPosts();
        }

        function logout() {
            DB.currentUser = null;
            DB.presidentKey = false;
            document.body.classList.remove('president-mode');
            expandedPostId = null; // é‡ç½®å±•å¼€çŠ¶æ€
            document.getElementById('guest-state').classList.remove('hidden');
            document.getElementById('user-state').classList.add('hidden');
            document.getElementById('sidebar-profile').classList.add('hidden');
            renderPosts();
        }

        function showAuth() {Â 
            document.getElementById('auth-modal').classList.remove('hidden');Â 
        }
        function closeAuth() {Â 
            document.getElementById('auth-modal').classList.add('hidden');Â 
        }
        function switchAuth(type) {
            document.getElementById('auth-login-panel').classList.toggle('hidden', type !== 'login');
            document.getElementById('auth-reg-panel').classList.toggle('hidden', type !== 'register');
            document.getElementById('auth-tab-login').className = `flex-1 py-3 text-center font-bold ${type === 'login' ? 'bg-[#8B0000] text-white' : 'text-gray-400 hover:bg-[#2a2a2a]'}`;
            document.getElementById('auth-tab-reg').className = `flex-1 py-3 text-center font-bold ${type === 'register' ? 'bg-[#8B0000] text-white' : 'text-gray-400 hover:bg-[#2a2a2a]'}`;
        }
        function openPostModal() {Â 
            if (!DB.currentUser) { showAuth(); return; }Â 
            document.getElementById('post-modal').classList.remove('hidden');Â 
            document.getElementById('post-title').value = '';
            document.getElementById('post-content').value = '';
            document.getElementById('edit-post-id').value = '';
            document.getElementById('post-modal-title').textContent = 'å‘å¸ƒæ–°å¸–';
        }
        function closePostModal() {Â 
            document.getElementById('post-modal').classList.add('hidden');Â 
        }
        function handleRegister() {Â 
            showToast('æ³¨å†ŒåŠŸèƒ½å·²å…³é—­ï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼‰', 'error');Â 
        }
        function showRules() {Â 
            alert('ç¤¾åŒºæ³•è§„ï¼šä¸¥ç¦ä¼ æ’­æ¶‰å¯†ä¿¡æ¯ï¼Œè¿è€…ä¾æ³•å¤„ç†ã€‚\n\næ‰“èµè§„åˆ™ï¼šæ‰“èµ10ç§¯åˆ†ï¼Œä½œè€…è·å¾—1ç§¯åˆ†ï¼ˆ10%è½¬åŒ–ç‡ï¼Œç±»ä¼¼Bç«™æŠ•å¸æœºåˆ¶ï¼‰');Â 
        }
        function editPost(id) {Â 
            const post = DB.posts.find(p => p.id === id);
            if (post) {
                document.getElementById('post-title').value = post.title;
                document.getElementById('post-content').value = post.content;
                document.getElementById('edit-post-id').value = id;
                document.getElementById('post-modal-title').textContent = 'ç¼–è¾‘å¸–å­';
                document.getElementById('post-modal').classList.remove('hidden');
            }
        }
        function deletePost(id) {Â 
            if (confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) {
                const post = DB.posts.find(p => p.id === id);
                const isAuthor = post && DB.currentUser && post.author === DB.currentUser.username;
               Â 
                // å¦‚æœå½“å‰å±•å¼€çš„å¸–å­è¢«åˆ é™¤ï¼Œé‡ç½®å±•å¼€çŠ¶æ€
                if (expandedPostId === id) {
                    expandedPostId = null;
                }
               Â 
                DB.posts = DB.posts.filter(p => p.id !== id);
                renderPosts();
                updateStats();
               Â 
                // åªæœ‰ä½œè€…åˆ é™¤è‡ªå·±çš„å¸–å­æ‰æ‰£åˆ†ï¼Œä¼šé•¿åˆ é™¤ä¸æ‰£
                if (isAuthor && !isPresident()) {
                    modifyPoints(-5, 'åˆ é™¤å¸–å­');
                }
            }
        }
        function stickyPost(id) {Â 
            const p = DB.posts.find(p => p.id === id);Â 
            if (p) {Â 
                p.isSticky = true;Â 
                renderPosts();Â 
            }Â 
        }
        function unstickyPost(id) {Â 
            const p = DB.posts.find(p => p.id === id);Â 
            if (p) {Â 
                p.isSticky = false;Â 
                renderPosts();Â 
            }Â 
        }

        // å¤´åƒç³»ç»Ÿ
        function openAvatarModal() {Â 
            if (!DB.currentUser) return;Â 
            document.getElementById('avatar-modal').classList.remove('hidden');Â 
            document.getElementById('avatar-current-preview').src = DB.currentUser.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${DB.currentUser.username}`;
            tempAvatarData = null;
            document.getElementById('avatar-new-preview-container').classList.add('hidden');
            document.getElementById('avatar-save-btn').disabled = true;
            document.getElementById('avatar-save-btn').classList.add('opacity-50');
        }
        function closeAvatarModal() {Â 
            document.getElementById('avatar-modal').classList.add('hidden');Â 
        }
        function handleAvatarSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) {Â 
                showToast('å›¾ç‰‡ä¸èƒ½è¶…è¿‡2MB', 'error');Â 
                return;Â 
            }
            const reader = new FileReader();
            reader.onload = function(evt) {
                tempAvatarData = evt.target.result;
                document.getElementById('avatar-new-preview').src = tempAvatarData;
                document.getElementById('avatar-new-preview-container').classList.remove('hidden');
                document.getElementById('avatar-save-btn').disabled = false;
                document.getElementById('avatar-save-btn').classList.remove('opacity-50');
            };
            reader.readAsDataURL(file);
        }
        function saveAvatar() {
            if (!tempAvatarData || !DB.currentUser) return;
            DB.currentUser.avatar = tempAvatarData;
            updateAvatarDisplay();
            showToast('å¤´åƒæ›´æ–°æˆåŠŸ', 'success');
            closeAvatarModal();
            renderPosts();
        }
        function updateAvatarDisplay() {
            if (!DB.currentUser) return;
            const url = DB.currentUser.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${DB.currentUser.username}`;
            document.getElementById('user-avatar').src = url;
            document.getElementById('sidebar-avatar').src = url;
        }
        function managePoints() {
            if (!isPresident()) return;
            // ç®€å•ç®¡ç†åŠŸèƒ½ï¼šç»™æŒ‡å®šç”¨æˆ·åŠ å‡ç§¯åˆ†
            const target = prompt('è¯·è¾“å…¥ç›®æ ‡ç”¨æˆ·åï¼š');
            if (!target) return;
            const user = DB.users[target];
            if (!user) {
                showToast('ç”¨æˆ·ä¸å­˜åœ¨', 'error');
                return;
            }
            const amount = parseInt(prompt(`å½“å‰ç”¨æˆ· ${target} ç§¯åˆ†ï¼š${getDisplayPoints(user)}\nè¯·è¾“å…¥è¦è°ƒæ•´çš„ç§¯åˆ†æ•°é‡ï¼ˆè´Ÿæ•°æ‰£é™¤ï¼‰ï¼š`));
            if (isNaN(amount)) return;
           Â 
            user.points += amount;
            showToast(`å·²è°ƒæ•´ ${target} ç§¯åˆ† ${amount > 0 ? '+' : ''}${amount}`, 'success');
            console.log(`[ADMIN] ${DB.currentUser.username} è°ƒæ•´ ${target} ç§¯åˆ† ${amount}`);
           Â 
            // å¦‚æœè°ƒæ•´çš„æ˜¯å½“å‰ç”¨æˆ·ï¼Œæ›´æ–°æ˜¾ç¤º
            if (user === DB.currentUser) {
                updatePointsDisplay();
            }
        }
        function viewAuditLog() {Â 
            alert('å®¡è®¡æ—¥å¿—ï¼šä»…ä¼šé•¿å¯è§\n\næœ€è¿‘æ“ä½œï¼š\n1. ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ\n2. ç§¯åˆ†ç³»ç»ŸåŠ è½½å®Œæˆ\n3. æ— é™ç§¯åˆ†ç‰¹æƒå·²æ¿€æ´»');Â 
        }

        function showToast(msg, type = 'info') {
            const toast = document.createElement('div');
            const colors = { success: 'bg-green-600', error: 'bg-red-600', warning: 'bg-yellow-600', info: 'bg-blue-600' };
            toast.className = `fixed top-20 right-4 ${colors[type] || colors.info} text-white px-4 py-2 rounded shadow-lg z-[9999] animate-bounce`;
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
